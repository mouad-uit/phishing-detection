<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Détection de Phishing - XGBoost</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f5f7fb;
        margin: 0;
        padding: 0;
        padding-top: 20px;
        display: flex;
        align-items: start;
        justify-content: center;
        /* min-height: 100vh; */
      }
      .card {
        background: #ffffff;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        padding: 12px;
        max-width: 600px;
        width: 100%;
      }
      h1 {
        margin: 8px;
        font-size: 1.25rem;
        text-align: center;
      }
      p.subtitle {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 0.95rem;
        color: #555;
        text-align: center;
      }
      form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #d0d4e4;
        font-size: 0.95rem;
      }
      button {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        background: #2563eb;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover:not(:disabled) {
        background: #1d4ed8;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        opacity: 0.7;
      }
      input:disabled,
      input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .loading-container {
        display: none;
        text-align: center;
        padding: 12px;
        margin-top: 8px;
      }
      .loading-container.active {
        display: block;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f4f6;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        margin-left: 8px;
        color: #6b7280;
        font-size: 0.9rem;
      }
      .validation-error {
        display: none;
        color: #b91c1c;
        font-size: 0.85rem;
        margin-top: 4px;
        padding: 6px 8px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
      }
      .validation-error.active {
        display: block;
      }
      input.invalid {
        border-color: #b91c1c;
        background: #fef2f2;
      }
      input.valid {
        border-color: #10b981;
      }
      #errorContainer,
      #resultContainer {
        margin-top: 8px;
      }
      #errorContainer .error,
      #resultContainer .result {
        margin-top: 0;
      }
      .result,
      .error {
        padding: 12px 14px;
        border-radius: 8px;
        font-size: 0.95rem;
        margin-top: 4px;
      }
      .result-safe {
        background: #ecfdf3;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .result-danger {
        background: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
      }
      .error {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }
      .small {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 8px;
      }
      code {
        background: #f3f4f6;
        padding: 2px 4px;
        border-radius: 4px;
      }
      #predictForm {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .accordion {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-top: 12px;
        overflow: hidden;
      }

      .accordion-header {
        background: #f9fafb;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
      }

      .accordion-body {
        display: none;
        padding: 12px 14px;
        background: #ffffff;
        font-size: 0.9rem;
      }

      .accordion.active .accordion-body {
        display: block;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px 12px;
      }

      .accordion-arrow {
        transition: transform 0.25s ease;
      }

      .accordion.active .accordion-arrow {
        transform: rotate(180deg);
      }

    </style>
  </head>
  <body>
    <div class="card">
      <h1>Détection de sites de phishing</h1>
      <p class="subtitle">
        Modèle XGBoost
        <!-- Modèle XGBoost entraîné sur des caractéristiques d'URL et de page HTML. -->
      </p>

      <form id="predictForm">
        <input
          type="text"
          name="url"
          id="urlInput"
          placeholder="Entrez un URL (https://www.monsite.com)"
          required
        />
        <button type="submit" id="submitBtn">Analyser</button>
      </form>

      <div class="validation-error" id="validationError"></div>

      <div class="loading-container" id="loadingContainer">
        <div style="display: flex; align-items: center; justify-content: center;">
          <div class="spinner"></div>
          <span class="loading-text">Analyse en cours...</span>
        </div>
      </div>

      <!-- Container for error messages -->
      <div id="errorContainer"></div>

      <!-- Container for results -->
      <div id="resultContainer"></div>

      <!-- Container for details accordion -->
      <div id="detailsAccordion"></div>

    </div>

    <script>
      const form = document.getElementById("predictForm");
      const urlInput = document.getElementById("urlInput");
      const submitBtn = document.getElementById("submitBtn");
      const loadingContainer = document.getElementById("loadingContainer");
      const validationError = document.getElementById("validationError");
      const errorContainer = document.getElementById("errorContainer");
      const resultContainer = document.getElementById("resultContainer");

      // URL validation function
      function isValidURL(url) {
        if (!url || url.trim() === "") {
          return { valid: false, message: "Veuillez saisir une URL." };
        }

        const trimmedUrl = url.trim();
        
        // Basic URL pattern check
        const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i;
        const ipPattern = /^(https?:\/\/)?(\d{1,3}\.){3}\d{1,3}(:\d+)?([\/\w \.-]*)*\/?$/;
        
        // Check if it's a valid URL format
        try {
          // Try to create a URL object (works for full URLs)
          if (trimmedUrl.includes("://")) {
            new URL(trimmedUrl);
            return { valid: true, message: "" };
          } else {
            // For URLs without protocol, check if it looks like a domain
            if (urlPattern.test(trimmedUrl) || ipPattern.test(trimmedUrl)) {
              return { valid: true, message: "" };
            } else {
              return { valid: false, message: "Format d'URL invalide. Exemple: https://www.example.com" };
            }
          }
        } catch (e) {
          return { valid: false, message: "Format d'URL invalide. Exemple: https://www.example.com" };
        }
      }

      // Display error message
      function displayError(message) {
        errorContainer.innerHTML = `<div class="error">${message}</div>`;
        resultContainer.innerHTML = "";
      }

      // Display result
      function displayResult(result) {
        const isPhishing = result.prediction === 1;
        const resultClass = isPhishing ? "result-danger" : "result-safe";
        const resultText = isPhishing 
          ? "Ce site est probablement <strong>phishing</strong>"
          : "Ce site semble <strong>légitime</strong>";
        const probability = (result.probability * 100).toFixed(2);

        resultContainer.innerHTML = `
          <div class="result ${resultClass}">
            ${resultText}
            <span> / </span>
            <span>
              Probabilité phishing ≈
              <code>${probability}%</code>
            </span>
          </div>
        `;
        errorContainer.innerHTML = "";
      }

      function displayDetails(details) {
        const container = document.getElementById("detailsAccordion");

        const formattedJson = JSON.stringify(details, null, 2);

        container.innerHTML = `
          <div class="accordion" id="accordionBox">
            <div class="accordion-header">
              <span>Détails techniques du site</span>
              <span class="accordion-arrow">▼</span>
            </div>
            <div class="accordion-body">
              <pre style="
                white-space: pre-wrap;
                word-break: break-word;
                background: #f3f4f6;
                padding: 12px;
                border-radius: 8px;
                /* font-size: 0.85rem; */
                max-height: 300px;
                overflow: auto;
              ">${formattedJson}</pre>
            </div>
          </div>
        `;

        document
          .querySelector(".accordion-header")
          .addEventListener("click", () => {
            document.getElementById("accordionBox").classList.toggle("active");
          });
      }

      // Real-time validation on input
      urlInput.addEventListener("input", function () {
        const urlValue = urlInput.value.trim();
        const validation = isValidURL(urlValue);
        
        if (urlValue === "") {
          urlInput.classList.remove("invalid", "valid");
          validationError.classList.remove("active");
        } else if (validation.valid) {
          urlInput.classList.remove("invalid");
          urlInput.classList.add("valid");
          validationError.classList.remove("active");
        } else {
          urlInput.classList.remove("valid");
          urlInput.classList.add("invalid");
          validationError.textContent = validation.message;
          validationError.classList.add("active");
        }
      });

      // Validate on blur (when user leaves the input)
      urlInput.addEventListener("blur", function () {
        const urlValue = urlInput.value.trim();
        const validation = isValidURL(urlValue);
        
        if (!validation.valid && urlValue !== "") {
          urlInput.classList.add("invalid");
          validationError.textContent = validation.message;
          validationError.classList.add("active");
        }
      });

      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // Prevent default form submission

        // Validate URL before submission
        const urlValue = urlInput.value.trim();
        const validation = isValidURL(urlValue);
        
        if (!validation.valid) {
          urlInput.classList.add("invalid");
          validationError.textContent = validation.message;
          validationError.classList.add("active");
          urlInput.focus();
          return false;
        }

        // Clear any previous validation errors, results, and errors
        urlInput.classList.remove("invalid");
        validationError.classList.remove("active");
        errorContainer.innerHTML = "";
        resultContainer.innerHTML = "";

        // Disable input and button, show loading
        urlInput.readOnly = true;
        submitBtn.disabled = true;
        loadingContainer.classList.add("active");

        try {
          // Send AJAX request to backend
          const response = await fetch("/predict", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ url: urlValue }),
          });

          const data = await response.json();

          if (data.success) {
            displayResult(data.result);
            displayDetails(data.result.details);
          } else {
            displayError(data.error || "Une erreur est survenue.");
          }
        } catch (error) {
          displayError(`Erreur de connexion : ${error.message}`);
        } finally {
          // Re-enable input and button, hide loading
          urlInput.readOnly = false;
          submitBtn.disabled = false;
          loadingContainer.classList.remove("active");
        }
      });

      // Reset form state on page load
      window.addEventListener("load", function () {
        urlInput.readOnly = false;
        submitBtn.disabled = false;
        loadingContainer.classList.remove("active");
        urlInput.classList.remove("invalid", "valid");
        validationError.classList.remove("active");
        errorContainer.innerHTML = "";
        resultContainer.innerHTML = "";
      });
    </script>
  </body>
  </html>


